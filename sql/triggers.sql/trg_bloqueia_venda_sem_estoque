create trigger trg_bloqueia_venda_sem_estoque
on itensvenda
instead of insert
as
begin
    set nocount on;

    if exists (
        select 1
        from inserted i
        join produtos p on p.id_produto = i.produto_id
        where p.estoque < i.quantidade
    )
    begin
        raiserror('venda bloqueada: produto sem estoque suficiente!', 16, 1);
        rollback transaction;
        return;
    end

    insert into itensvenda (venda_id, produto_id, quantidade, preco_unitario)
    select i.venda_id, i.produto_id, i.quantidade, i.preco_unitario
    from inserted i;

    update p
    set p.estoque = p.estoque - i.quantidade
    from produtos p
    join inserted i on p.id_produto = i.produto_id;
end;
go